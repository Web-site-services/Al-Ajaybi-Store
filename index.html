<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>متجر العجايبي - إدارة وشراء و رصيد المخزون</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- SEO Meta Tags -->
  <meta name="description" content="متجر العجايبي: إدارة وشراء وتخزين احترافي للأدوات المكتبية والمدرسية. تسوق دفاتر، أقلام، مستلزمات مكتبية، عروض حصرية وتوصيل سريع. اطلب عبر الموقع أو تواصل معنا عبر واتساب، فيسبوك، تويتر، انستجرام.">
  <meta name="keywords" content="متجر العجايبي, أدوات مكتبية, قرطاسية, شراء, إدارة مخزون, تسوق, طلبات, مخزن, جملة, تجزئة, عروض, دفاتر, أقلام, ورق, مكتبة, توصيل, WhatsApp, Facebook, Twitter, Instagram, TikTok, سوشيال ميديا">
  <meta property="og:title" content="متجر العجايبي - إدارة وشراء وتخزين احترافي">
  <meta property="og:description" content="تسوق أفضل أدوات مكتبية ومدرسية، واطلب بسهولة عبر كافة منصات التواصل الاجتماعي.">
  <meta property="og:url" content="https://yourcompany.com/">
  <meta property="og:site_name" content="متجر العجايبي">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://i.imgur.com/Vp5j7dH.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="متجر العجايبي - إدارة وشراء وتخزين احترافي">
  <meta name="twitter:description" content="حلول احترافية لطلبات الأدوات المكتبية والمدرسية والتوصيل السريع وخدمة العملاء عبر جميع قنوات السوشيال ميديا.">
  <meta name="twitter:image" content="https://i.imgur.com/Vp5j7dH.png">
  <link rel="canonical" href="https://yourcompany.com/">
  <link rel="icon" href="https://i.imgur.com/Vp5j7dH.png">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
  <style>
    body {font-family: 'Cairo', Arial, sans-serif; background: #f5f9fa; margin:0; color:#252525;}
    header {background: linear-gradient(90deg, #4a7c59 80%, #7bcfae 100%); color: #fff; padding: 22px 0 18px 0; text-align: center; border-bottom-left-radius: 28px; border-bottom-right-radius: 28px; box-shadow: 0 3px 22px #4a7c5910; position:relative;}
    .header-btns-top {
      position: absolute;
      left: 18px;
      top: 18px;
      display: flex;
      gap: 14px;
      z-index: 10;
      transition: opacity .2s;
    }
    .header-btns-top button {
      background: #fff;
      color: #4a7c59;
      border: none;
      padding: 9px 19px;
      border-radius: 22px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 8px #0001;
      transition: background 0.15s;
    }
    .header-btns-top button:hover {background:#d3e7db;}
    main {max-width: 1250px; margin: 38px auto 24px auto; background: #fff; border-radius: 22px; box-shadow: 0 8px 44px #4a7c5916; padding: 32px 14px 24px 14px; min-height:650px;}
    .notif-bar {font-size: 16px; color: #fff; background: #c0392b; padding: 8px 16px; border-radius: 8px; margin-bottom: 13px; text-align: center; font-weight: bold; display: none;}
    .notif-bar.visible {display: block;}

    /* شاشة المنتجات */
    .client-card, .client-form-container {
      margin: 0 auto 26px auto;
      background: #e0f2f1;
      border-radius: 15px;
      width: 340px;
      max-width: 95vw;
      box-shadow: 0 0 18px #0001;
      padding: 23px 15px 25px 15px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeInDown 0.4s;
      transition: box-shadow 0.15s;
      justify-content: center;
    }
    .client-form-container {background: #e0f8f2;}
    .client-contact-mid {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      min-height: 240px;
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .client-card h3, .client-form h3 {margin-top:0; font-size: 20px; color: #25764b;}
    .client-card .edit-btn {position:absolute;left:10px;top:10px;background:#4a7c59;color:#fff;padding:4px 15px;border-radius:16px;border:none;font-size:15px;cursor:pointer;}
    .client-card .edit-btn:hover {background:#2a4c39;}
    .client-card label{display:inline-block;font-weight:700;width:85px;text-align:right;}
    .client-card .val{display:inline-block;width:210px;font-weight:400;text-align:right;}
    .client-form {width:100%; display:flex; flex-direction:column; align-items:center; gap:4px;}
    .client-form label {display:block;margin:14px 0 6px 0;font-weight:700;font-size:15px; color:#3e6a4b;text-align:right;width:100%;}
    .client-form input {
      width:100%;padding:8px 10px;border-radius:6px;border:1.2px solid #b2dfdb;
      margin-bottom:2px; font-size:15px; background:#f8fcfa; transition: border 0.2s;
      box-sizing: border-box;
    }
    .client-form input:focus {border:1.2px solid #4a7c59; outline:none;}
    .client-form button {
      width:100%;background:#4a7c59;color:#fff;border:none;padding:12px 0;border-radius:8px;
      font-size:17px;margin-top:15px;font-weight:bold;transition:background 0.14s;
      letter-spacing:1px;
    }
    .client-form button:hover {background: #388e3c;}
    .client-form .to-shop-btn {background: #25764b; color: #fff;}
    .client-form .to-shop-btn:hover {background: #1a513a;}
    .client-form .form-title {
      font-size: 22px;
      font-weight: 700;
      color: #24704b;
      margin-bottom: 7px;
      margin-top: 0;
      letter-spacing: 1px;
      text-align:center;
    }
    .flex {display:flex;gap:38px;flex-wrap:wrap;align-items:flex-start;}
    aside.filters {
      flex:0 0 265px;
      background: #f4f8fb;
      border-radius: 12px;
      box-shadow: 0 0 11px #0001;
      padding: 22px 16px 28px 16px;
      min-width: 230px;
      position: relative;
    }
    aside.filters h3 {margin:0 0 18px 0; font-weight:700; color:#3e6a4b;}
    .filter-group {border-bottom:1px solid #e0e0e0;margin-bottom:8px;}
    .filter-main {
      display:flex;align-items:center;font-size:16px;font-weight:700;cursor:pointer;padding:5px 0;
    }
    .filter-main .toggle {
      font-size:22px;display:inline-block;width:24px;text-align:center;margin-left:4px;color:#4a7c59;
      font-weight: bold;
    }
    .filter-main .main-label{flex:1;}
    .sub-filters {margin:5px 0 0 0;padding-right:13px;display:none;}
    .sub-filters.active{display:block;}
    .sub-filters label {display:flex;align-items:center;font-size:15px;font-weight:400;margin-bottom:3px;cursor:pointer;}
    .sub-filters input[type=checkbox]{margin-left:8px;}
    .num-prod {display:block;font-size:15px;color:#4a7c59;padding:8px 0 3px 0;font-weight:bold;}
    .filters-btns {margin-bottom:8px;}
    .filters-btns button {background:#7bcfae;color:#fff;border:none;padding:5px 13px;border-radius:8px;font-size:15px;cursor:pointer;margin-left:7px;}
    .filters-btns button:hover {background:#4a7c59;}
    .product-search-container {
      margin: 7px 0 14px 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .product-search-box {
      font-family: inherit;
      direction: rtl;
      background: #fff;
      border: 1.2px solid #b2dfdb;
      border-radius: 11px;
      padding: 9px 16px 9px 35px;
      font-size: 16px;
      color: #25764b;
      width: 97%;
      box-sizing: border-box;
      outline: none;
      transition: border 0.18s;
      box-shadow: 0 0 7px #0001;
    }
    .product-search-box:focus {
      border-color: #4a7c59;
    }
    .search-icon {
      position: relative;
      right: -32px;
      font-size: 19px;
      color: #4a7c59;
      pointer-events: none;
      top: 1px;
      margin-left: -29px;
    }
    .products {flex: 1 1 400px; display:flex; flex-wrap:wrap; gap:28px; min-width:320px; position:relative;}
    .products .back-btn {
      position: absolute;
      left: 0;
      top: 0;
      background: #fff;
      color: #4a7c59;
      border: none;
      padding: 8px 19px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 8px #0001;
      margin: 8px 0 0 10px;
      z-index: 5;
      transition: background 0.14s;
    }
    .products .back-btn:hover {background: #d3e7db;}
    .products .show-order-btn {
      position: absolute;
      left: 0;
      top: 50px;
      background: #fff;
      color: #4a7c59;
      border: none;
      padding: 8px 19px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 8px #0001;
      margin: 8px 0 0 10px;
      z-index: 5;
      transition: background 0.14s;
    }
    .products .show-order-btn:hover {background: #d3e7db;}
    .products .to-inventory-btn {
      position: absolute;
      left: 0;
      top: 100px;
      background: #25764b;
      color: #fff;
      border: none;
      padding: 8px 19px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 0 8px #0001;
      margin: 8px 0 0 10px;
      z-index: 5;
      transition: background 0.14s;
    }
    .products .to-inventory-btn:hover {background: #388e3c;}
    .product {background:#f7fdfc;border:1.7px solid #b2dfdb;border-radius:10px;box-shadow:0 2px 13px #0001;width:200px;text-align:center;padding:13px 7px 16px 7px;min-height:320px;display:flex;flex-direction:column;align-items:center;}
    .product img {width:100%;height:110px;object-fit:contain;border-radius:8px;margin-bottom:10px;background:#e0f2f1;}
    .product h4 {font-size:17px;margin:0 0 8px 0;color:#25764b;font-weight:700;}
    .product .not-available {color: #c0392b;font-size:15px;font-weight:700; margin:10px 0 6px 0;}
    .product .in-stock {color: #388e3c;font-size:14px;margin-top:0;font-weight:700;margin-bottom:6px;}
    .product .qty-row {display:flex;align-items:center;gap:6px;justify-content:center;}
    .product .qty-row input[type=number] {width:48px;padding:1px 4px;border-radius:3px;border:1px solid #bbb;text-align:center;font-size:15px;}
    .product button {background:#4a7c59;color:#fff;border:none;padding:8px 14px;border-radius:5px;font-size:15px;cursor:pointer;margin-top:12px;font-weight:700;}
    .product button:disabled {background:#b0b0b0;cursor:not-allowed;color:#eee;}
    .product button:hover:not(:disabled) {background:#3e6a4b;}
    .product .price {font-size:15.5px;color:#2d5e4c;font-weight:700;margin-bottom:7px;}
    .cart-section {margin-top:30px;background:#e7f7f1;border-radius:13px;padding:22px 18px 12px 18px;box-shadow:0 0 14px #0001;max-width:820px;margin-right:auto;margin-left:auto;}
    .cart-section h3 {margin-top:0;color:#4a7c59;letter-spacing:1px;font-weight:700;}
    .cart-table {width:100%;border-collapse:collapse;background:#fff;border-radius:9px;margin-bottom:15px;overflow:hidden;box-shadow:0 1px 7px #0001;}
    .cart-table th, .cart-table td {border:1px solid #bfd9ce;padding:9px 6px;text-align:center;font-size:15.5px;}
    .cart-table th {background:#4a7c59;color:#fff;font-weight:700;font-size:16.5px;}
    .cart-table td button {background:#b94a48;font-size:13px;padding:2px 11px;border-radius:5px;color:#fff;border:none;cursor:pointer;font-weight:bold;}
    .cart-table td button:hover {background:#8c3b39;}
    .cart-total {font-size:20px;color:#3e6a4b;font-weight:bold;text-align:left;margin-top:8px;margin-bottom:17px;}
    .cart-actions {display:flex;gap:15px;flex-wrap:wrap;margin-bottom:8px;justify-content:flex-end;}
    .cart-actions button {background:#4a7c59;color:#fff;border:none;padding:11px 0;border-radius:6px;font-size:16px;cursor:pointer;font-weight:700;letter-spacing:1px;transition:background 0.17s;}
    .cart-actions button:hover {background:#3e6a4b;}
    /* شاشة أمر الشراء */
    .order-html-modal-bg {position:fixed;top:0;left:0;width:100vw;height:100vh;background:#0007;z-index:90;display:flex;align-items:center;justify-content:center;}
    .order-html-modal-bg.hidden {display:none;}
    .order-html-modal {
      background:#fff;border-radius:16px;box-shadow:0 12px 48px #0005;
      min-width:320px;
      max-width:900px;
      width:96vw;
      position:relative;
      padding:30px 35px 18px 35px;
      direction:rtl;
      animation:popIn 0.22s;
      max-height:80vh;
      overflow-y:auto;
      /* scrollbar for modal */
      scrollbar-width: thin;
      scrollbar-color: #4a7c59 #e0f8f2;
    }
    .order-html-modal .close-modal {position:absolute;top:13px;left:12px;font-size:22px;background:#eee;color:#c0392b;border:none;border-radius:50%;width:36px;height:36px;cursor:pointer;font-weight:bold;}
    .order-html-modal .close-modal:hover {background:#fde2e2;}
    .order-html-modal h3 {margin-top:0;color:#4a7c59;font-weight:700;text-align:center;}
    .order-html-modal table {width:100%;border-collapse:collapse;margin-bottom:12px;font-size:19px;border-radius:10px;box-shadow:0 2px 10px #4a7c5950;}
    .order-html-modal th, .order-html-modal td {border: 1.5px solid #b2dfdb; padding: 13px 10px; text-align: center;}
    .order-html-modal th {background: #4a7c59; color: #fff; font-weight: 800; font-size: 21px;}
    .order-html-modal .total-row td {font-weight:bold;font-size:20px;color:#c0392b;background:#f7f7f7;}
    .order-html-modal .order-customer {background:#f2f8f3;border-radius:7px;padding:13px 10px;margin-bottom:10px;font-size:17px;}
    .order-html-modal .order-date {text-align:left;font-size:15.5px;color:#444;margin-bottom:8px;font-style:italic;}
    .order-html-modal .order-modal-btns {display:flex;gap:10px;justify-content:center;margin:14px 0 3px 0;flex-wrap:wrap;}
    .order-html-modal .order-modal-btns button {background:#4a7c59;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-size:17px;cursor:pointer;font-weight:700;transition:background 0.18s;margin-bottom:4px;}
    .order-html-modal .order-modal-btns button:hover {background:#3e6a4b;}
    @keyframes popIn {from {transform: scale(0.92);}to {transform: scale(1);}}

    /* شاشة رصيد المخزن */
    #inventoryArea {display:none; margin-top: 8px;}
    .inventory-flex {display: flex; gap: 36px; flex-wrap: wrap; align-items:flex-start;}
    .inventory-filters {
      flex:0 0 265px;
      background: #f4f8fb;
      border-radius: 12px;
      box-shadow: 0 0 11px #0001;
      padding: 22px 16px 28px 16px;
      min-width: 230px;
      position: relative;
    }
    .inventory-filters h3 {margin:0 0 18px 0; font-weight:700; color:#3e6a4b;}
    .inventory-num-prod {display:block;font-size:15px;color:#4a7c59;padding:8px 0 3px 0;font-weight:bold;}
    .inventory-filters .filters-btns button {background:#7bcfae;color:#fff;border:none;padding:5px 13px;border-radius:8px;font-size:15px;cursor:pointer;margin-left:7px;}
    .inventory-filters .filters-btns button:hover {background:#4a7c59;}
    .inventory-product-search-container {
      margin: 7px 0 14px 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .inventory-product-search-box {
      font-family: inherit;
      direction: rtl;
      background: #fff;
      border: 1.2px solid #b2dfdb;
      border-radius: 11px;
      padding: 9px 16px 9px 35px;
      font-size: 16px;
      color: #25764b;
      width: 97%;
      box-sizing: border-box;
      outline: none;
      transition: border 0.18s;
      box-shadow: 0 0 7px #0001;
    }
    .inventory-product-search-box:focus {
      border-color: #4a7c59;
    }
    .inventory-products-area {flex: 1 1 400px; min-width:320px; position:relative;}
    .inventory-controls {display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 18px; justify-content: flex-end;}
    .inventory-controls button {background:#4a7c59;color:#fff;border:none;padding:8px 18px;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer;transition:background 0.14s;}
    .inventory-controls button:hover {background:#3e6a4b;}
    .inventory-controls input[type=file]{display:none;}
    .inventory-table-wrapper {max-height: 440px; overflow-y: auto; border-radius: 12px; border: 1.4px solid #b2dfdb; background: #f7fdfc; box-shadow: 0 1px 7px #0001;}
    .inventory-table {border-collapse: collapse; width: 100%;}
    .inventory-table th, .inventory-table td {border: 1px solid #b2dfdb; padding: 10px 6px; text-align: center; font-size: 15.5px;}
    .inventory-table th {background: #4a7c59; color: #fff; font-weight: 700; font-size: 16px;}
    .inventory-table td img {width:44px;height:36px;object-fit:cover;border-radius:7px;}
    .inventory-table td button {background: #4a7c59; color: #fff; border: none; padding: 5px 10px; border-radius: 6px; font-size: 15px; font-weight:700; cursor: pointer; transition:background 0.15s;}
    .inventory-table td button.del {background: #b94a48;}
    .inventory-table td button.del:hover{background:#8c3b39;}
    .inventory-table td button:hover {background:#3e6a4b;}
    .pagination-bar {
      display: flex; justify-content: center; align-items: center; gap: 7px; margin: 22px 0 0 0; flex-wrap: wrap;
    }
    .pagination-bar button {
      background: #e0f8f2;
      border: 1px solid #b2dfdb;
      color: #25764b;
      font-weight: 700;
      padding: 6px 13px;
      border-radius: 7px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.14s;
    }
    .pagination-bar button.active, .pagination-bar button:focus {
      background: #25764b;
      color: #fff;
      border-color: #25764b;
    }
    .pagination-bar button:hover:not(.active) {
      background: #b2dfdb;
    }
    .pagination-bar span {
      font-size: 15px;
      color: #4a7c59;
      padding: 0 7px;
      font-weight: bold;
    }

    /* نموذج إضافة/تعديل صنف */
    .inventory-modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #0007;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInDown 0.22s;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #4a7c59 #e0f8f2;
    }
    .inventory-modal {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 12px 48px #0005;
      min-width: 330px;
      max-width: 99vw;
      width: 400px;
      position: relative;
      padding: 26px 24px 18px 24px;
      direction: rtl;
      animation: popIn 0.22s;
      overflow-y: auto;
      max-height: 95vh;
      scrollbar-width: thin;
      scrollbar-color: #4a7c59 #e0f8f2;
    }
    .inventory-modal::-webkit-scrollbar {
      width: 8px;
    }
    .inventory-modal::-webkit-scrollbar-thumb {
      background: #4a7c59;
      border-radius: 7px;
    }
    .inventory-modal::-webkit-scrollbar-track {
      background: #e0f8f2;
    }
    .inventory-modal h2 {margin:0 0 22px 0; color:#4a7c59;font-weight:700;text-align:center;}
    .inventory-modal .close-modal {
      position: absolute; top: 14px; left: 12px;
      font-size: 23px;
      background: #eee;
      color: #c0392b;
      border: none;
      border-radius: 50%;
      width: 37px; height: 37px;
      cursor: pointer; font-weight: bold;
      transition: background 0.13s;
    }
    .inventory-modal .close-modal:hover {background:#fde2e2;}
    .inventory-add-edit-form label {display:block; margin:12px 0 4px 0; font-weight:700;color:#4a7c59;}
    .inventory-add-edit-form input {
      width: 100%; padding: 10px 11px; font-size: 15px; margin-bottom: 2px; border-radius: 8px;
      border: 1.5px solid #b2dfdb; font-family: inherit; background: #f7fdfc; transition: border 0.18s;
    }
    .inventory-add-edit-form input:focus {border:1.5px solid #4a7c59;}
    .inventory-add-edit-form .modal-btns {margin-top:18px;display:flex;gap:13px;justify-content:flex-end;}
    .inventory-add-edit-form .modal-btns button {
      font-size:15px; padding:9px 21px; border-radius:9px; font-weight:700;
      border:none;
      cursor:pointer;
      background: #25764b;
      color: #fff;
      transition: background 0.16s;
    }
    .inventory-add-edit-form .modal-btns button:last-child {background:#b94a48;}
    .inventory-add-edit-form .modal-btns button:hover {opacity:0.93;}
    /* نهاية نموذج إضافة/تعديل */

    /* تحسينات العرض على الشاشات الصغيرة */
    @media (max-width: 1050px) {.client-card, .client-form-container{width:99vw;}}
    @media (max-width: 950px) {
      .flex, .inventory-flex {flex-direction:column;}
      aside.filters, .inventory-filters {max-width: 98vw; margin-bottom: 18px;}
      .main {padding: 8vw 1vw;}
    }
    @media (max-width: 650px) {
      .client-card, .client-form-container {width:96vw;}
      .products .back-btn, .products .show-order-btn {left: 0; top: 0; margin-top: 8px;}
      .products .show-order-btn {top: 45px;}
      .products .to-inventory-btn {top: 90px;}
      .inventory-modal{width:99vw;padding:10px 1vw 8px 1vw; min-width: 95vw;}
      .order-html-modal {width:99vw;padding:10px 1vw 8px 1vw;}
      .main {padding: 3vw 1vw;}
    }
    /* Scrollbars for modal and main for touch devices */
    @media (max-width: 480px) {
      .inventory-modal, .order-html-modal {max-height: 98vh;}
      .main {padding: 1vw;}
    }
  </style>
</head>
<body>
<header>
  <div class="header-btns-top" id="headerBtnsTop">
    <button onclick="showOrderHTML()" id="showOrderBtn">👁️ عرض أمر الشراء</button>
    <button class="edit-btn" id="editUserBtn" onclick="editClientData()">تعديل بيانات مستخدم⬅️</button>
    <button id="gotoInventoryBtn" onclick="showInventoryArea()">رصيد المخزن</button>
    <button id="gotoShopBtn" style="display:none" onclick="hideInventoryArea()">رجوع للمنتجات</button>
  </div>
  <h2>متجر العجايبي</h2>
  <p style="margin:0;font-size:18px; font-weight:700; letter-spacing:1px;">إدارة وشراء وتخزين احترافي</p>
  <!-- روابط سوشيال ميديا أسفل العنوان -->
  <div style="margin-top:7px;display:flex;justify-content:center;gap:13px;">
    <a href="https://wa.me/201202153265" target="_blank" style="color:#fff;font-size:22px;text-decoration:none;">واتساب</a>
    <a href="https://www.facebook.com/" target="_blank" style="color:#fff;font-size:22px;text-decoration:none;">فيسبوك</a>
    <a href="https://twitter.com/" target="_blank" style="color:#fff;font-size:22px;text-decoration:none;">تويتر</a>
    <a href="https://www.instagram.com/" target="_blank" style="color:#fff;font-size:22px;text-decoration:none;">انستجرام</a>
    <a href="https://t.me/" target="_blank" style="color:#fff;font-size:22px;text-decoration:none;">تليجرام</a>
  </div>
</header>
<main class="main">
  <div id="clientSection"></div>
  <div id="notifBar" class="notif-bar"></div>
  <!-- منطقة المنتجات والسلة -->
  <div id="shopArea">
    <div class="flex" id="shopSection" style="display:none">
      <aside class="filters">
        <h3>فلترة المنتجات</h3>
        <div class="filters-btns">
          <button onclick="toggleAllFilters(true)">تحديد الكل</button>
          <button onclick="toggleAllFilters(false)">إلغاء الكل</button>
        </div>
        <div id="dynamicFilters"></div>
        <span class="num-prod" id="numProducts"></span>
        <div class="product-search-container">
          <input type="text" id="productSearch" class="product-search-box" placeholder="🔎 ابحث باسم/نوع المنتج..." oninput="applyFilters()" />
        </div>
      </aside>
      <section class="products" id="productsList"></section>
    </div>
    <section class="cart-section" id="cartSection" style="display:none">
      <h3>الأصناف المطلوبة</h3>
      <table class="cart-table" id="cartTable">
        <thead>
          <tr>
            <th>الصنف</th>
            <th>الكمية</th>
            <th>السعر</th>
            <th>القيمة</th>
            <th>مسح</th>
          </tr>
        </thead>
        <tbody id="cartItems"></tbody>
      </table>
      <div class="cart-total" id="cartTotal">المجموع: 0 ج.م</div>
      <div class="cart-actions">
        <button onclick="showOrderHTML()" id="cartShowOrderBtn">👁️ عرض أمر الشراء</button>
      </div>
    </section>
  </div>
  <!-- منطقة رصيد المخزون -->
  <div id="inventoryArea">
    <div class="inventory-flex">
      <aside class="inventory-filters">
        <h3>فلترة الأصناف</h3>
        <div class="filters-btns">
          <button onclick="toggleAllInventoryFilters(true)">تحديد الكل</button>
          <button onclick="toggleAllInventoryFilters(false)">إلغاء الكل</button>
        </div>
        <div id="inventoryDynamicFilters"></div>
        <span class="inventory-num-prod" id="inventoryNumProducts"></span>
        <div class="inventory-product-search-container">
          <input type="text" id="inventoryProductSearch" class="inventory-product-search-box" placeholder="🔎 ابحث باسم/نوع الصنف..." oninput="applyInventoryFilters()" />
        </div>
      </aside>
      <div class="inventory-products-area">
        <div class="inventory-controls">
          <button onclick="downloadInventoryExcel()">تحميل كـ Excel</button>
          <input type="file" id="excelUpload" accept=".csv" onchange="uploadExcelFile(event)">
        </div>
        <div class="inventory-table-wrapper">
          <table class="inventory-table" id="inventoryTable"></table>
        </div>
        <div class="pagination-bar" id="paginationBar"></div>
        <!-- نموذج إضافة/تعديل في نافذة منبثقة -->
        <div id="productModal" style="display:none;"></div>
      </div>
    </div>
  </div>
  <!-- شاشة أمر الشراء -->
  <div class="order-html-modal-bg hidden" id="orderHtmlModalBg">
    <div class="order-html-modal">
      <button class="close-modal" onclick="closeOrderHtmlModal()">×</button>
      <div id="orderHtmlContent"></div>
      <div class="order-modal-btns">
        <button onclick="printOrderHtml()">🖨️ طباعة</button>
        <button onclick="downloadOrderHtml()">💾 تحميل HTML</button>
        <button onclick="shareOrderWhatsApp()">📱 واتساب</button>
        <button onclick="shareOrderEmail()">✉️ إيميل</button>
      </div>
    </div>
  </div>
</main>
<footer>
  <div style="text-align:center">📧 info@yourcompany.com | 📞 0500000000</div>
  <div style="text-align:center; margin-top:6px;">
    تابعنا على
    <a href="https://wa.me/201202153265" target="_blank" style="color:#4a7c59;text-decoration:none;">واتساب</a> -
    <a href="https://www.facebook.com/" target="_blank" style="color:#4a7c59;text-decoration:none;">فيسبوك</a> -
    <a href="https://twitter.com/" target="_blank" style="color:#4a7c59;text-decoration:none;">تويتر</a> -
    <a href="https://www.instagram.com/" target="_blank" style="color:#4a7c59;text-decoration:none;">انستجرام</a>
  </div>
  <div style="text-align:center">© 2025 متجر المستلزمات الورقية</div>
</footer>
<script>
// ---- بيانات المنتجات و تخزين موحد ----
let productsData = JSON.parse(localStorage.getItem('inventoryData')||'[]').length
  ? JSON.parse(localStorage.getItem('inventoryData'))
  : [
    { id: "d1", name: "دفتر سلك 60 ورقة", price: 7, mainCat: "أدوات مكتبية", category: "دفاتر", stock: 10, img: "https://i.imgur.com/Vp5j7dH.png" },
    { id: "d2", name: "دفتر جامعي 100 ورقة", price: 13, mainCat: "أدوات مكتبية", category: "دفاتر", stock: 5, img: "https://i.imgur.com/2Ud9P4q.png" },
    { id: "k1", name: "قلم أزرق جاف", price: 3, mainCat: "أدوات كتابية", category: "أقلام", stock: 50, img: "https://i.imgur.com/zx9c59V.png" }
  ];

// ---- منطقة المنتجات (index.html logic) ----
let cart = [];
let clientData = JSON.parse(localStorage.getItem('clientData')||'{}');
let lastSearch = "";

function updateHeaderBtns(show) {
  const headerBtns = document.getElementById('headerBtnsTop');
  if (show) {
    headerBtns.style.opacity = '1';
    headerBtns.style.pointerEvents = 'auto';
    document.getElementById('showOrderBtn').style.display = 'inline-block';
    document.getElementById('editUserBtn').style.display = 'inline-block';
    document.getElementById('gotoInventoryBtn').style.display = 'inline-block';
  } else {
    headerBtns.style.opacity = '0';
    headerBtns.style.pointerEvents = 'none';
    setTimeout(()=>{ // Hide only after fade
      document.getElementById('showOrderBtn').style.display = 'none';
      document.getElementById('editUserBtn').style.display = 'none';
      document.getElementById('gotoInventoryBtn').style.display = 'none';
    }, 180);
  }
}

// 1- اخفاء زراير عرض أمر شراء و تعديل بيانات مستخدم و رصيد المخزن عند ادخال بيانات العميل
function updateClientCardView() {
  let section = document.getElementById('clientSection');
  if (!clientData.name) {
    section.innerHTML = `<div class="client-form-container client-contact-mid">
      <form class="client-form" id="clientForm" onsubmit="return setClientData();" autocomplete="off" style="display:block">
        <div class="form-title">تسجيل بيانات العميل</div>
        <label>الاسم:<input type="text" id="clientName" required placeholder="مثال: أحمد العجايبي"></label>
        <label>الإيميل:<input type="email" id="clientEmail" required placeholder="example@email.com"></label>
        <label>الهاتف:<input type="tel" id="clientPhone" required placeholder="05XXXXXXXX"></label>
        <label>العنوان:<input type="text" id="clientAddress" required placeholder="مثال: الرياض - حي العليا"></label>
        <button type="submit" class="to-shop-btn">الانتقال لطلب المنتجات</button>
      </form>
    </div>`;
    document.getElementById('shopSection').style.display = 'none';
    document.getElementById('cartSection').style.display = 'none';
    updateHeaderBtns(false);
  } else {
    section.innerHTML = `<div class="client-card client-contact-mid">
      <button class="edit-btn" onclick="editClientData()">تعديل</button>
      <h3>بيانات العميل</h3>
      <div><label>الاسم:</label><span class="val">${clientData.name}</span></div>
      <div><label>الإيميل:</label><span class="val">${clientData.email}</span></div>
      <div><label>الهاتف:</label><span class="val">${clientData.phone}</span></div>
      <div><label>العنوان:</label><span class="val">${clientData.address}</span></div>
    </div>`;
    document.getElementById('shopSection').style.display = 'flex';
    document.getElementById('cartSection').style.display = 'block';
    buildFilterGroups();
    renderProducts();
    updateCart();
    setTimeout(()=>{ section.innerHTML = ""; }, 400);
    updateHeaderBtns(true);
  }
}

function setClientData() {
  let name = document.getElementById('clientName').value.trim();
  let email = document.getElementById('clientEmail').value.trim();
  let phone = document.getElementById('clientPhone').value.trim();
  let address = document.getElementById('clientAddress').value.trim();
  if (!name || !email || !phone || !address) {
    notif('يرجى تعبئة كل بيانات العميل!', "#c0392b");
    return false;
  }
  clientData = {name, email, phone, address};
  localStorage.setItem('clientData', JSON.stringify(clientData));
  updateClientCardView();
  return false;
}
function editClientData() {
  document.getElementById('clientSection').innerHTML = `<div class="client-form-container client-contact-mid">
    <form class="client-form" id="clientForm" onsubmit="return setClientData();" autocomplete="off" style="display:block">
      <div class="form-title">تعديل بيانات العميل</div>
      <label>الاسم:<input type="text" id="clientName" value="${clientData.name||""}" required></label>
      <label>الإيميل:<input type="email" id="clientEmail" value="${clientData.email||""}" required></label>
      <label>الهاتف:<input type="tel" id="clientPhone" value="${clientData.phone||""}" required></label>
      <label>العنوان:<input type="text" id="clientAddress" value="${clientData.address||""}" required></label>
      <button type="submit" class="to-shop-btn">الانتقال لطلب المنتجات</button>
    </form>
  </div>`;
  document.getElementById('shopSection').style.display = 'none';
  document.getElementById('cartSection').style.display = 'none';
  updateHeaderBtns(false);
}
let notifTimeout = null;
function notif(msg, color="#c0392b") {
  const bar = document.getElementById('notifBar');
  bar.textContent = msg;
  bar.style.background = color;
  bar.classList.add('visible');
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(()=>bar.classList.remove('visible'), 2500);
}
// ==== الفلاتر الاحترافية ====
// ... (بدون تغيير)
let shopFilters = {checked: {}, search: ""}; // المنتجات فقط
function buildFilterGroups() {
  let groups = {};
  productsData.forEach(p=>{
    if(!groups[p.mainCat]) groups[p.mainCat]=[];
    if(!groups[p.mainCat].includes(p.category)) groups[p.mainCat].push(p.category);
  });
  let filters = ``;
  Object.entries(groups).forEach(([mainCat, subs],i)=>{
    let subFilt = subs.map(sub=>{
      let sum = productsData.filter(x=>x.category===sub).reduce((a,b)=>a+b.stock,0);
      let checked = (shopFilters.checked[sub] !== false) ? "checked" : "";
      return `<label>
        <input type="checkbox" class="sub-cat-chk" data-main="${mainCat}" value="${sub}" ${checked} onchange="applyFilters()"> 
        ${sub} <span style="color:#388e3c;font-weight:bold;font-size:13px;">(${sum})</span>
      </label>`;
    }).join("");
    filters += `<div class="filter-group">
      <div class="filter-main" onclick="toggleFilterGroup(this)">
        <span class="toggle">+</span>
        <span class="main-label">${mainCat}</span>
      </div>
      <div class="sub-filters">${subFilt}</div>
    </div>`;
  });
  document.getElementById('dynamicFilters').innerHTML = filters;
  let firstGroup = document.querySelector('.filter-group .sub-filters');
  if(firstGroup){ firstGroup.classList.add('active'); firstGroup.previousElementSibling.querySelector('.toggle').textContent = '-'; }
}
function toggleFilterGroup(el){
  let sub = el.nextElementSibling;
  if(sub.classList.contains('active')){
    sub.classList.remove('active');
    el.querySelector('.toggle').textContent = '+';
  } else {
    sub.classList.add('active');
    el.querySelector('.toggle').textContent = '-';
  }
}
function toggleAllFilters(val){
  document.querySelectorAll('.sub-cat-chk').forEach(chk=>{
    chk.checked = val;
    shopFilters.checked[chk.value] = val;
  });
  applyFilters();
}
function applyFilters() {
  shopFilters.checked = {};
  document.querySelectorAll('.sub-cat-chk').forEach(chk=>{
    shopFilters.checked[chk.value] = chk.checked;
  });
  renderProducts();
}
// ==== المنتجات ====
// ... (بدون تغيير)
function renderProducts() {
  let productsList = document.getElementById('productsList');
  productsList.innerHTML = "";
  // زر رجوع و زر عرض أمر الشراء أعلى المنتجات يسار
  let backBtn = document.createElement("button");
  backBtn.className = "back-btn";
  backBtn.onclick = function() {
    document.getElementById('clientSection').innerHTML = `<div class="client-card client-contact-mid">
      <button class="edit-btn" onclick="editClientData()">تعديل</button>
      <h3>بيانات العميل</h3>
      <div><label>الاسم:</label><span class="val">${clientData.name}</span></div>
      <div><label>الإيميل:</label><span class="val">${clientData.email}</span></div>
      <div><label>الهاتف:</label><span class="val">${clientData.phone}</span></div>
      <div><label>العنوان:</label><span class="val">${clientData.address}</span></div>
    </div>`;
    document.getElementById('shopSection').style.display = 'none';
    document.getElementById('cartSection').style.display = 'none';
    updateHeaderBtns(false);
  };
  let showOrderBtn = document.createElement("button");
  showOrderBtn.className = "show-order-btn";
  showOrderBtn.onclick = function() { showOrderHTML(); };
  let toInventoryBtn = document.createElement("button");
  //toInventoryBtn.className = "to-inventory-btn";
  //toInventoryBtn.innerHTML = "  ";
  toInventoryBtn.onclick = showInventoryArea;
  productsList.appendChild(backBtn);
  productsList.appendChild(showOrderBtn);
  productsList.appendChild(toInventoryBtn);
  // مربع البحث
  let searchBox = document.getElementById('productSearch');
  let search = searchBox ? searchBox.value.trim() : "";
  let checkedSubs = [];
  document.querySelectorAll('.sub-cat-chk').forEach(chk=>{
    if(chk.checked) checkedSubs.push(chk.value);
  });
  let count = 0;
  productsData.forEach(prod => {
    let matchSearch = true;
    if (search) {
      let s = search.toLowerCase();
      matchSearch = (prod.name && prod.name.toLowerCase().includes(s)) ||
        (prod.category && prod.category.toLowerCase().includes(s));
    }
    if (checkedSubs.includes(prod.category) && matchSearch) {
      count++;
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML =
        `<img src="${prod.img}" alt="${prod.name}"/>
         <h4>${prod.name}</h4>
         <div class="price">${prod.price} ج.م</div>
         <div class="${prod.stock > 0 ? 'in-stock' : 'not-available'}">
           ${prod.stock > 0 ? prod.stock+' متوفر' : 'غير متوفر'}
         </div>
         <div class="qty-row">
           <input type="number" min="1" max="${prod.stock}" value="1" id="qty_${prod.id}" ${prod.stock === 0 ? 'disabled' : ''}>
         </div>
         <button onclick="addToCart('${prod.id}')" ${prod.stock === 0 ? 'disabled' : ''}>${prod.stock > 0 ? 'أضف للسلة' : 'غير متاح'}</button>`;
      productsList.appendChild(div);
    }
  });
  document.getElementById('numProducts').textContent = `عدد الأصناف المعروضة: ${count}`;
}
function addToCart(prodId) {
  const prod = productsData.find(p=>p.id===prodId);
  if (!prod) return;
  const qtyInput = document.getElementById('qty_' + prodId);
  let qty = parseInt(qtyInput.value);
  if (isNaN(qty) || qty < 1) return notif("الكمية غير صحيحة", "#c0392b");
  if (qty > prod.stock) return notif("الكمية المطلوبة أكبر من المتوفر!", "#c0392b");
  const existing = cart.find(i=>i.id===prodId);
  if (existing) {
    if (existing.qty + qty > prod.stock) return notif("الكمية الإجمالية المطلوبة أكبر من المتوفر!", "#c0392b");
    existing.qty += qty;
  } else {
    cart.push({ ...prod, qty });
  }
  updateCart();
  notif("تم إضافة المنتج للسلة.", "#388e3c");
}
// ==== السلة ====
// ... (بدون تغيير)
function updateCart() {
  const tb = document.getElementById('cartItems');
  tb.innerHTML = '';
  let total = 0;
  cart.forEach((item, idx) => {
    const val = item.price * item.qty;
    total += val;
    const row = document.createElement('tr');
    row.innerHTML =
      `<td>${item.name}</td>
       <td>${item.qty}</td>
       <td>${item.price} ج.م</td>
       <td>${val} ج.م</td>
       <td><button onclick="removeFromCart(${idx})">X</button></td>`;
    tb.appendChild(row);
  });
  document.getElementById('cartTotal').textContent = "المجموع: " + total + " ج.م";
}
function removeFromCart(idx) {
  cart.splice(idx, 1);
  updateCart();
}
// ==== أمر الشراء ====
// 6- إضافة بيانات المتجر أسفل أمر الشراء
function getCurrentDateTimeStr() {
  const d = new Date();
  return d.toLocaleDateString('ar-EG') + " - " + d.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
}
function showOrderHTML() {
  if (cart.length === 0) { notif("السلة فارغة!", "#c0392b"); return; }
  const total = cart.reduce((sum, item)=>sum+(item.price*item.qty), 0);
  const nowStr = getCurrentDateTimeStr();
  let html = `<h3>أمر شراء - متجر العجايبي</h3>
    <div class="order-date">تاريخ الطلب: ${nowStr}</div>
    <div class="order-customer">
      <b>اسم العميل:</b> ${clientData.name}<br>
      <b>الإيميل:</b> ${clientData.email}<br>
      <b>الهاتف:</b> ${clientData.phone}<br>
      <b>العنوان:</b> ${clientData.address}
    </div>
    <table>
    <thead>
      <tr>
        <th>الصنف</th><th>الكمية</th><th>السعر</th><th>القيمة</th>
      </tr>
    </thead><tbody>`;
  cart.forEach(item => {
    html += `<tr>
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td>${item.price} ج.م</td>
      <td>${item.price*item.qty} ج.م</td>
    </tr>`;
  });
  html += `<tr class="total-row"><td colspan="3">المجموع الكلي</td><td>${total} ج.م</td></tr>`;
  html += `</tbody></table>`;
  html += `<div style="text-align:center;font-size:16px;margin-top:7px;color:#4a7c59;font-weight:bold">
    شكراً لاختياركم متجر العجايبي
  </div>
  <div style="text-align:center;margin-top:6px;">
    <b>بيانات المتجر:</b> <br> 
    📧 info@yourcompany.com | 📞 0500000000 <br>
    تابعنا على: 
    <a href="https://wa.me/201202153265" target="_blank" style="color:#25764b;text-decoration:none;font-weight:700;">واتساب</a> - 
    <a href="https://www.facebook.com/" target="_blank" style="color:#25764b;text-decoration:none;font-weight:700;">فيسبوك</a> - 
    <a href="https://twitter.com/" target="_blank" style="color:#25764b;text-decoration:none;font-weight:700;">تويتر</a> - 
    <a href="https://www.instagram.com/" target="_blank" style="color:#25764b;text-decoration:none;font-weight:700;">انستجرام</a>
  </div>`;
  document.getElementById('orderHtmlContent').innerHTML = html;
  document.getElementById('orderHtmlModalBg').classList.remove('hidden');
}
function closeOrderHtmlModal() {
  document.getElementById('orderHtmlModalBg').classList.add('hidden');
}
function printOrderHtml() {
  const content = document.getElementById('orderHtmlContent').innerHTML;
  const win = window.open('', '', 'width=900,height=900');
  win.document.write(`<html><head><title>أمر شراء - متجر العجايبي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
  <style>body{font-family:'Cairo',Arial,sans-serif;direction:rtl;padding:25px;}table{width:100%;border-collapse:collapse;font-size:18px;}th,td{border:1.5px solid #b2dfdb;padding:13px 10px;text-align:center;}th{background:#4a7c59;color:#fff;font-size:20px;}</style>
  </head><body>${content}</body></html>`);
  win.document.close();
  setTimeout(() => win.print(), 500);
}
function downloadOrderHtml() {
  const content = document.getElementById('orderHtmlContent').innerHTML;
  const htmlPage = `<html><head><meta charset="utf-8"><title>أمر شراء</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',Arial,sans-serif;direction:rtl;padding:25px;}
    .order-date{font-size:16px;color:#444;}
    .order-customer{background:#f2f8f3;border-radius:7px;padding:13px 10px;margin-bottom:10px;font-size:17px;}
    table{width:100%;border-collapse:collapse;font-size:18px;}
    th,td{border:1.5px solid #b2dfdb;padding:13px 10px;text-align:center;}
    th{background:#4a7c59;color:#fff;font-size:20px;}
    .total-row td{font-weight:bold;font-size:20px;color:#c0392b;background:#f7f7f7;}
  </style>
  </head><body>${content}</body></html>`;
  const blob = new Blob([htmlPage], {type: "text/html"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "طلب_شراء.html";
  a.click();
}
function shareOrderWhatsApp() {
  const total = cart.reduce((sum, item)=>sum+(item.price*item.qty), 0);
  const message =
    `مرحباً، أود طلب المنتجات التالية:\n` +
    cart.map(item => `${item.name} - ${item.qty} × ${item.price} ج.م`).join('\n') +
    `\nالمجموع: ${total} ج.م\n\nبيانات العميل:\nالاسم: ${clientData.name}\nالهاتف: ${clientData.phone}\nالعنوان: ${clientData.address}`;
  const whatsappUrl = `https://wa.me/201202153265?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}
function shareOrderEmail() {
  const total = cart.reduce((sum, item)=>sum+(item.price*item.qty), 0);
  const subject = "طلب شراء من متجر العجايبي";
  const body =
    `السلام عليكم،\nأود طلب المنتجات التالية:\n` +
    cart.map(item => `${item.name} - ${item.qty} × ${item.price} ج.م`).join('\n') +
    `\nالمجموع: ${total} ج.م\n\nبيانات العميل:\nالاسم: ${clientData.name}\nالبريد الإلكتروني: ${clientData.email}\nالهاتف: ${clientData.phone}\nالعنوان: ${clientData.address}\n\nمع الشكر.`;
  const mailtoLink = `mailto:info@yourcompany.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(mailtoLink, '_blank');
}

// ==== شاشة رصيد المخزن ====
// 3- إخفاء زرار عرض أمر الشراء و رصيد المخزن عند الانتقال لرصيد المخزون
function showInventoryArea() {
  document.getElementById('shopArea').style.display = 'none';
  document.getElementById('inventoryArea').style.display = 'block';
  document.getElementById('gotoInventoryBtn').style.display = 'none';
  document.getElementById('gotoShopBtn').style.display = 'inline-block';
  document.getElementById('editUserBtn').style.display = 'none';
  document.getElementById('showOrderBtn').style.display = 'none';
  // أيضاً زر عرض أمر الشراء في السلة
  let cartShowOrderBtn = document.getElementById('cartShowOrderBtn');
  if(cartShowOrderBtn) cartShowOrderBtn.style.display = "none";
  buildInventoryFilterGroups();
  applyInventoryFilters();
}
function hideInventoryArea() {
  document.getElementById('shopArea').style.display = 'block';
  document.getElementById('inventoryArea').style.display = 'none';
  document.getElementById('gotoInventoryBtn').style.display = 'inline-block';
  document.getElementById('gotoShopBtn').style.display = 'none';
  document.getElementById('editUserBtn').style.display = 'inline-block';
  document.getElementById('showOrderBtn').style.display = 'inline-block';
  let cartShowOrderBtn = document.getElementById('cartShowOrderBtn');
  if(cartShowOrderBtn) cartShowOrderBtn.style.display = "inline-block";
  buildFilterGroups();
  renderProducts();
  updateCart();
}
// ==== المخزون مع الفلترة والبحث وترقيم الصفحات ====
// ... (بدون تغيير)
let inventoryFilters = {checked: {}, search: ""};
function buildInventoryFilterGroups() {
  let groups = {};
  productsData.forEach(p=>{
    if(!groups[p.mainCat]) groups[p.mainCat]=[];
    if(!groups[p.mainCat].includes(p.category)) groups[p.mainCat].push(p.category);
  });
  let filters = ``;
  Object.entries(groups).forEach(([mainCat, subs],i)=>{
    let subFilt = subs.map(sub=>{
      let sum = productsData.filter(x=>x.category===sub).reduce((a,b)=>a+b.stock,0);
      let checked = (inventoryFilters.checked[sub] !== false) ? "checked" : "";
      return `<label>
        <input type="checkbox" class="inventory-sub-cat-chk" data-main="${mainCat}" value="${sub}" ${checked} onchange="applyInventoryFilters()"> 
        ${sub} <span style="color:#388e3c;font-weight:bold;font-size:13px;">(${sum})</span>
      </label>`;
    }).join("");
    filters += `<div class="filter-group">
      <div class="filter-main" onclick="toggleInventoryFilterGroup(this)">
        <span class="toggle">+</span>
        <span class="main-label">${mainCat}</span>
      </div>
      <div class="sub-filters">${subFilt}</div>
    </div>`;
  });
  document.getElementById('inventoryDynamicFilters').innerHTML = filters;
  let firstGroup = document.querySelector('#inventoryDynamicFilters .filter-group .sub-filters');
  if(firstGroup){ firstGroup.classList.add('active'); firstGroup.previousElementSibling.querySelector('.toggle').textContent = '-'; }
}
function toggleInventoryFilterGroup(el){
  let sub = el.nextElementSibling;
  if(sub.classList.contains('active')){
    sub.classList.remove('active');
    el.querySelector('.toggle').textContent = '+';
  } else {
    sub.classList.add('active');
    el.querySelector('.toggle').textContent = '-';
  }
}
function toggleAllInventoryFilters(val){
  document.querySelectorAll('.inventory-sub-cat-chk').forEach(chk=>{
    chk.checked = val;
    inventoryFilters.checked[chk.value] = val;
  });
  applyInventoryFilters();
}
function applyInventoryFilters() {
  inventoryFilters.checked = {};
  document.querySelectorAll('.inventory-sub-cat-chk').forEach(chk=>{
    inventoryFilters.checked[chk.value] = chk.checked;
  });
  renderInventoryTable();
}
let pageSize = 50;
let currentPage = 1;
function renderInventoryTable() {
  let checkedSubs = [];
  document.querySelectorAll('.inventory-sub-cat-chk').forEach(chk=>{
    if(chk.checked) checkedSubs.push(chk.value);
  });
  let searchBox = document.getElementById('inventoryProductSearch');
  let search = searchBox ? searchBox.value.trim() : "";
  let filtered = productsData.filter(prod=>{
    let matchSearch = true;
    if (search) {
      let s = search.toLowerCase();
      matchSearch = (prod.name && prod.name.toLowerCase().includes(s)) ||
        (prod.category && prod.category.toLowerCase().includes(s));
    }
    return checkedSubs.includes(prod.category) && matchSearch;
  });
  let count = filtered.length;
  document.getElementById('inventoryNumProducts').textContent = `عدد الأصناف المعروضة: ${count}`;
  let totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  let start = (currentPage - 1) * pageSize;
  let pageProducts = filtered.slice(start, start + pageSize);
  let html = `<tr>
    <th>صورة</th>
    <th>الاسم</th>
    <th>الرئيسي</th>
    <th>الكود/مجموعة الصنف</th>
    <th>السعر</th>
    <th>الرصيد</th>
  </tr>`;
  pageProducts.forEach((prod,i) => {
    html += `<tr>
      <td><img src="${prod.img||'https://via.placeholder.com/44x36?text=منتج'}" /></td>
      <td>${prod.name}</td>
      <td>${prod.mainCat}</td>
      <td>${prod.category}</td>
      <td>${prod.price}</td>
      <td>${prod.stock}</td>
    </tr>`;
  });
  document.getElementById('inventoryTable').innerHTML = html;
  renderPagination(filtered.length);
}
function renderPagination(totalLen) {
  let totalPages = Math.max(1, Math.ceil(totalLen / pageSize));
  let html = '';
  if (totalPages > 1) {
    html += `<button ${currentPage==1?'disabled':''} onclick="gotoPage(1)">الأولى</button>`;
    html += `<button ${currentPage==1?'disabled':''} onclick="gotoPage(${currentPage-1})">السابق</button>`;
    let min = Math.max(1, currentPage-2), max = Math.min(totalPages, currentPage+2);
    for(let p=min;p<=max;p++) {
      html += `<button class="${p==currentPage?'active':''}" onclick="gotoPage(${p})">${p}</button>`;
    }
    html += `<button ${currentPage==totalPages?'disabled':''} onclick="gotoPage(${currentPage+1})">التالي</button>`;
    html += `<button ${currentPage==totalPages?'disabled':''} onclick="gotoPage(${totalPages})">الأخيرة</button>`;
    html += `<span>صفحة ${currentPage} من ${totalPages}</span>`;
  }
  document.getElementById('paginationBar').innerHTML = html;
}
function gotoPage(p) {
  currentPage = p;
  renderInventoryTable();
}
// 2- شاشة إضافة/تعديل صنف: ضبط الحجم مع سكرول جانبي عند صغر الشاشة
function openProductModal(idx = null) {
  let p = idx !== null ? productsData[idx] : {};
  let modal = document.getElementById('productModal');
  modal.innerHTML = `
    <div class="inventory-modal-bg" onclick="if(event.target===this)closeProductModal()">
      <div class="inventory-modal">
        <button class="close-modal" type="button" onclick="closeProductModal()">&times;</button>
        <form class="inventory-add-edit-form" id="addEditProductForm" onsubmit="return saveProductFormModal();">
          <h2 style="margin-top:0;">${idx!==null ? "تعديل الصنف" : "إضافة صنف جديد"}</h2>
          <label>اسم الصنف<input type="text" id="prodName" required value="${p.name||''}"></label>
          <label>المجموعة الرئيسية<input type="text" id="prodMainCat" placeholder="مثال: أدوات مكتبية" required value="${p.mainCat||''}"></label>
          <label>مجموعة الصنف (الكود)<input type="text" id="prodCat" placeholder="مثال: دفاتر" required value="${p.category||''}"></label>
          <label>السعر<input type="number" id="prodPrice" min="0" step="0.5" required value="${typeof p.price==='number'?p.price:''}"></label>
          <label>الرصيد<input type="number" id="prodStock" min="0" required value="${typeof p.stock==='number'?p.stock:''}"></label>
          <label>رابط صورة المنتج<input type="url" id="prodImg" placeholder="https://..." value="${p.img||''}" ></label>
          <div class="modal-btns">
            <button type="submit" id="saveProdBtn">حفظ</button>
            <button type="button" onclick="closeProductModal()">إلغاء</button>
          </div>
          <input type="hidden" id="prodIdx" value="${idx!==null?idx:""}">
        </form>
      </div>
    </div>
  `;
  modal.style.display = "block";
  setTimeout(()=>{
    let n = document.getElementById('prodName');
    if(n) n.focus();
  },120);
}
function closeProductModal() {
  document.getElementById('productModal').style.display = "none";
  document.getElementById('productModal').innerHTML = '';
}
function saveProductFormModal() {
  const name = document.getElementById('prodName').value.trim();
  const mainCat = document.getElementById('prodMainCat').value.trim();
  const cat = document.getElementById('prodCat').value.trim();
  const price = parseFloat(document.getElementById('prodPrice').value);
  const stock = parseInt(document.getElementById('prodStock').value);
  const img = document.getElementById('prodImg').value.trim() || "https://via.placeholder.com/200x150?text=منتج";
  const idx = document.getElementById('prodIdx').value;
  if (name && mainCat && cat && !isNaN(price) && !isNaN(stock)) {
    if (idx !== '') {
      productsData[idx] = { ...productsData[idx], name, mainCat, category: cat, price, stock, img };
      notif("تم تعديل الصنف بنجاح", "#388e3c");
    } else {
      productsData.push({ id: "id" + Date.now(), name, mainCat, category: cat, price, stock, img });
      notif("تم إضافة الصنف بنجاح", "#388e3c");
    }
    saveInventoryData();
    buildFilterGroups();
    renderProducts();
    buildInventoryFilterGroups();
    renderInventoryTable();
    closeProductModal();
  }
  return false;
}
function saveInventoryData() {
  localStorage.setItem('inventoryData', JSON.stringify(productsData));
}
function deleteProduct(i) {
  if (confirm("هل تريد حذف هذا الصنف؟")) {
    productsData.splice(i,1);
    saveInventoryData();
    buildFilterGroups();
    renderProducts();
    buildInventoryFilterGroups();
    renderInventoryTable();
  }
}
function deleteAllProducts() {
  if (confirm("هل تريد حذف جميع الأصناف؟")) {
    productsData = [];
    saveInventoryData();
    buildFilterGroups();
    renderProducts();
    buildInventoryFilterGroups();
    renderInventoryTable();
    notif("تم حذف جميع الأصناف", "#c0392b");
  }
}
function downloadInventoryExcel() {
  let csv = "الاسم,الرئيسي,الكود,السعر,الرصيد,الصورة\n";
  productsData.forEach(p=>csv+=`${p.name},${p.mainCat},${p.category},${p.price},${p.stock},${p.img}\n`);
  let blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"}); // BOM for Arabic
  let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "المخزون.csv"; a.click();
  notif("تم تصدير الملف بنجاح","#388e3c");
}
function uploadExcelFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    const lines = ev.target.result.split('\n').filter(Boolean);
    productsData = [];
    for (let i=1; i<lines.length; i++) {
      const [name, mainCat, cat, price, stock, img] = lines[i].split(',');
      if(!name||!mainCat||!cat) continue;
      productsData.push({id:"id"+Date.now()+i,name,mainCat,category:cat,price:+price,stock:+stock,img:img||"https://via.placeholder.com/200x150?text=منتج"});
    }
    saveInventoryData();
    buildFilterGroups();
    renderProducts();
    buildInventoryFilterGroups();
    renderInventoryTable();
    notif("تم تحميل الأصناف من ملف Excel بنجاح", "#388e3c");
  };
  reader.readAsText(file,'utf-8');
}
// --- بدء الصفحة ---
window.onload = function() {
  updateClientCardView();
  buildFilterGroups();
  renderProducts();
  updateCart();
  buildInventoryFilterGroups();
  document.getElementById('shopArea').style.display = 'block';
  document.getElementById('inventoryArea').style.display = 'none';
  document.getElementById('gotoInventoryBtn').style.display = 'inline-block';
  document.getElementById('gotoShopBtn').style.display = 'none';
  updateHeaderBtns(!(!clientData.name));
};
</script>
</body>
</html>